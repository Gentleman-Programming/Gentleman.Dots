#!/usr/bin/env sh

# Yabai configuration migrated from AeroSpace

# Load scripting addition (required for native space switching with SIP partially disabled)
sudo yabai --load-sa
yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"

# global settings - visual enhancements
yabai -m config mouse_follows_focus          on
yabai -m config focus_follows_mouse          off
yabai -m config window_origin_display        default
yabai -m config window_placement             second_child
yabai -m config window_shadow                on
yabai -m config window_opacity               on
yabai -m config window_opacity_duration      0.2
yabai -m config active_window_opacity        1.0
yabai -m config normal_window_opacity        0.95
yabai -m config window_animation_duration    0.25
yabai -m config window_animation_easing      ease_out_circ
yabai -m config insert_feedback_color        0xff61afef
yabai -m config split_ratio                  0.50
yabai -m config auto_balance                 off
yabai -m config mouse_modifier               fn
yabai -m config mouse_action1                move
yabai -m config mouse_action2                resize
yabai -m config mouse_drop_action            swap

# SketchyBar integration
yabai -m config external_bar                 all:45:0

# SketchyBar signals - trigger updates on workspace/window changes
yabai -m signal --add event=space_changed action="sketchybar --trigger yabai_space_changed" label="sketchybar_space_changed"
yabai -m signal --add event=window_created action="sketchybar --trigger yabai_window_created" label="sketchybar_window_created"
yabai -m signal --add event=window_destroyed action="sketchybar --trigger yabai_window_destroyed" label="sketchybar_window_destroyed"
yabai -m signal --add event=window_moved action="sketchybar --trigger yabai_window_moved" label="sketchybar_window_moved"
yabai -m signal --add event=window_focused action="sketchybar --trigger yabai_space_changed" label="sketchybar_window_focused"

# general space settings - beautiful spacing
yabai -m config layout                       bsp
yabai -m config top_padding                  10
yabai -m config bottom_padding               6
yabai -m config left_padding                 6
yabai -m config right_padding                6
yabai -m config window_gap                   6

# space labels
# Display 1 (LG TV - Main): spaces 1-4
# Space 5: temporary/extra
# Space 6 (alt+6): Elgato Teleprompter
# Space 7 (alt+7): Arzopa Portable Monitor
yabai -m space 1 --label social 2>/dev/null || true
yabai -m space 2 --label work 2>/dev/null || true
yabai -m space 3 --label development 2>/dev/null || true
yabai -m space 4 --label others 2>/dev/null || true
yabai -m space 5 --label five 2>/dev/null || true
yabai -m space 6 --label teleprompter 2>/dev/null || true
yabai -m space 7 --label arzopa 2>/dev/null || true

# ─────────────────────────────────────────────────────────────────────────────────
# WINDOW RULES - Apps that don't play well with tiling
# ─────────────────────────────────────────────────────────────────────────────────

# System apps
yabai -m rule --add app="^Finder$" manage=off
yabai -m rule --add app="^System Settings$" manage=off
yabai -m rule --add app="^System Preferences$" manage=off
yabai -m rule --add app="^Calculator$" manage=off
yabai -m rule --add app="^Keychain Access$" manage=off
yabai -m rule --add app="^Archive Utility$" manage=off
yabai -m rule --add app="^App Store$" manage=off
yabai -m rule --add app="^Activity Monitor$" manage=off
yabai -m rule --add app="^Disk Utility$" manage=off
yabai -m rule --add app="^Font File Browser$" manage=off
yabai -m rule --add app="^System Information$" manage=off

# Slack - huddles, calls, and popups cause issues
yabai -m rule --add app="^Slack$" title="Huddle" manage=off
yabai -m rule --add app="^Slack$" title="(Call|Screen)" manage=off
yabai -m rule --add app="^Slack$" subrole="AXDialog" manage=off
yabai -m rule --add app="^Slack$" subrole="AXSystemDialog" manage=off

# Communication apps with problematic windows
yabai -m rule --add app="^zoom.us$" manage=off
yabai -m rule --add app="^Zoom$" manage=off
yabai -m rule --add app="^Discord$" title="(Friends|Nitro)" manage=off
yabai -m rule --add app="^Microsoft Teams" manage=off

# Development tools popups
yabai -m rule --add app="^Raycast$" manage=off
yabai -m rule --add app="^Alfred$" manage=off
yabai -m rule --add app="^1Password" manage=off

# Media
yabai -m rule --add app="^QuickTime Player$" manage=off
yabai -m rule --add app="^Preview$" manage=off
yabai -m rule --add app="^Music$" manage=off
yabai -m rule --add app="^Podcasts$" manage=off

# ─────────────────────────────────────────────────────────────────────────────────
# SIGNALS - Auto-fix problematic windows
# ─────────────────────────────────────────────────────────────────────────────────

# Re-tile windows when a problematic app closes a popup
yabai -m signal --add event=window_destroyed action="yabai -m query --windows --window &> /dev/null || yabai -m window --focus recent" label="focus_recent_on_destroy"

echo "yabai configuration loaded.."
